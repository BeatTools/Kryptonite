name: Build Kryptonite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout âœ¨
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Add msbuild to PATH ðŸ”—
      uses: microsoft/setup-msbuild@v1.1

    - name: Install dependencies ðŸ“¦
      run: nuget restore Kryptonite.sln

    - name: Build Kryptonite for release ðŸ§±
      run: msbuild -nologo -v:m -p:Configuration=Release Kryptonite.sln
    
    - name: Download a file
      run: curl https://github.com/SteamRE/DepotDownloader/releases/download/DepotDownloader_2.4.5/depotdownloader-2.4.5.zip -o ${{ github.workspace }}\Kryptonite\bin\Release\depotdownloader-2.4.5.zip

    - name: Package DepotDownloader for release ðŸ§±
      run: 7z x ${{ github.workspace }}\Kryptonite\bin\Release\depotdownloader-2.4.5.zip:${{ github.workspace }}\Kryptonite\bin\Release\depotdownloader-2.4.5.zip
      
    - name: Archive Kryptonite ðŸ§±
      uses: thedoctor0/zip-release@master
      with:
        path: ${{ github.workspace }}\Kryptonite\bin\Release\.
        exclusions: '*.xml* *.cmd* *.pdb* libraries\*.xml* libraries\*.pdb*'
        type: 'zip'
        filename: 'Kryptonite.zip'
    
    - name: Generate release tag ðŸ§±
      id: tag
      run: |
        echo "::set-output name=release_tag::Release_$(date +"%Y.%m.%d_%H-%M")"
        
    - name: Upload Release ðŸ“¦
      id: upload-release-asset 
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        files: |
          Kryptonite.zip
